name: ðŸš€ALERTING SERVICEðŸš€
run-name: Publish GCP Alerting Service
on: [push]

env:
  ENV: DEV
  REGION: europe-west1
  TEAMS_WEBHOOK: ${{ secrets.TEAMS_WEBHOOK }}
  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
  SERVICE_NAME: cnk-alerting-app

jobs:
  gcp-application:
    name: 'Provisioning GCP Application'
    runs-on: ubuntu-latest
    environment: production
    defaults:
      run:
        working-directory: ./deploy/alerting

    # Add "id-token" with the intended permissions.
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
    - name: Checkout
      uses: 'actions/checkout@v3'

    - name: 'Authenticate to Google Cloud'
      uses: google-github-actions/setup-gcloud@v0.3.0
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SERVICE_KEY }}
        export_default_credentials: true

    - name: Unit Test
      run: echo "Run Unit Tests"


    - name: Deploy Application test
      run: |-
        gcloud run deploy ${{ env.SERVICE_NAME }} \
          --region ${{ env.REGION }} \
          --image eu.gcr.io/${{ secrets.GCP_PROJECT_ID }}/cnk-alerting:1.0.0 \
          --platform "managed" \
          --region ${{ env.REGION }} \
          --memory 512Mi \
          --min-instances 1 \
          --max-instances 2 \
          --allow-unauthenticated \
          --update-env-vars ENV=${{ env.ENV }},GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }} \
          --update-secrets -secrets=webhook_url_teams_error=webhook_url_teams_error:latest,webhook_url_slack_error=webhook_url_slack_error:latest \
          --quiet


    # # # - name: Deploy Application
    # # #   uses: 'google-github-actions/deploy-cloudrun@v1'
    # # #   with:
    # # #     service: 'alerting-cloud-run'
    # # #     image: 'eu.gcr.io/${{ secrets.GCP_PROJECT_ID }}/cnk-alerting:1.0.0'
    # # #     platform: managed
    # # #     region: ${{ env.REGION }}
    # # #     memory: 512Mi
    # # #     min-instances: 1
    # # #     max-instances: 2
    # # #     update-env-vars: ENV=${{ env.ENV }},GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }}
    # # #     update-secrets: -secrets=webhook_url_teams_error=webhook_url_teams_error:latest,webhook_url_slack_error=webhook_url_slack_error:latest

    - name: Integration Test
      run: echo "Call the GCP Application"
